FROM node:20-alpine

WORKDIR /app/backend/api-gateway

# Install global dependencies
RUN npm install -g pnpm ts-node-dev

# Copy package files
COPY backend/api-gateway/package.json ./package.json
COPY backend/common ../common/

# Install common module first
WORKDIR /app/backend/common
RUN pnpm install --no-frozen-lockfile

# Return to api-gateway and install its dependencies
WORKDIR /app/backend/api-gateway
RUN pnpm install --no-frozen-lockfile && \
    pnpm add @as-integrations/express5

# Copy source files
COPY backend/api-gateway/src ./src/
COPY backend/api-gateway/tests ./tests/

# Expose the NestJS gateway port
EXPOSE 4000

# Start the service in dev mode
CMD ["pnpm", "start:dev"]
